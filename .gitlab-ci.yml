image : node:alpine

stages :
  - build
  - test
  - deploy
cache:
  key: $CI_COMMIT_REF_SLUG
  paths:
    - .npm/


build :
 
  stage: build 
  script:
    - npm ci --cache .npm --prefer-offline


  artifacts:
    expire_in: 1h
    paths:
      - node_modules/


test:
  stage: test
  services: 
    - selenium/standalone-chrome
  script: 
    - npm test
    - ./node_modules/.bin/wdio wdio.conf.js
  cache:
    key: $NODE_MODULES
    paths: 
      - .npm/


deploy:
  stage : deploy
  before_script :
    - 'command -v ssh-agent >/dev/null || ( apk add --update openssh )'
    - eval $(ssh-agent -s)
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa

    - ssh-add
    - ssh -o StrictHostKeyChecking=no root@$SERVER_IPADDRESS ufw allow 3000
    - 'apk add --upgrade gettext'
    - envsubst < deploy/env.template > $CI_PROJECT_DIR/.env
  script :
    - scp -r /builds/mod-team-project-2021/team22-21 root@$SERVER_IPADDRESS:/home/project
    - ssh -o StrictHostKeyChecking=no root@$SERVER_IPADDRESS 'pm2 delete all;cd /home/project/team22-21;npm install dotenv;pm2 start npm -- start'






